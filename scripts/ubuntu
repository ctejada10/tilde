#!/usr/bin/env bash


set -euo pipefail

# Always operate relative to this script's directory
cd "$(dirname "$0")"

USERNAME="ctejada"
PASSWORD="1234"
REPO_URL="https://github.com/ctejada10/tilde.git"
USER_HOME="/home/$USERNAME"

echo "[1/7] Creating user $USERNAME..."
if id "$USERNAME" &>/dev/null; then
    echo "User $USERNAME already exists. Skipping creation."
else
    useradd -m -s /bin/bash "$USERNAME"
    echo "$USERNAME:$PASSWORD" | chpasswd
    chage -d 0 "$USERNAME" # Force password change on first login
fi

echo "[2/7] Cloning repository into $USER_HOME/src..."
sudo -u "$USERNAME" mkdir -p "$USER_HOME/src"
if [ ! -d "$USER_HOME/src/tilde/.git" ]; then
    sudo -u "$USERNAME" git clone "$REPO_URL" "$USER_HOME/src/tilde"
else
    echo "Repository already cloned."
fi

echo "[3/7] Installing apps from .apt..."
source "$(dirname "$0")/.apt"

echo "[4/7] Stowing dotfiles for $USERNAME..."
for dir in btop git gpg ssh tmux zsh; do
    if [ -d "../dotfiles/$dir" ]; then
        sudo -u "$USERNAME" stow -d "../dotfiles" -t "$USER_HOME" "$dir"
    else
        echo "Warning: dotfiles/$dir does not exist."
    fi
done

echo "[5/7] Installing Oh My Zsh for $USERNAME..."
ZSH_DIR="$USER_HOME/.oh-my-zsh"
if [ ! -d "$ZSH_DIR" ]; then
    sudo -u "$USERNAME" env HOME="$USER_HOME" RUNZSH=no CHSH=no KEEP_ZSHRC=yes \
        sh -c 'curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh | sh'
else
    echo "Oh My Zsh already installed."
fi

echo "[6/7] Setting default shell to zsh for $USERNAME..."
ZSH_PATH="$(command -v zsh)"
if [ -n "$ZSH_PATH" ]; then
    chsh -s "$ZSH_PATH" "$USERNAME"
else
    echo "Warning: zsh not found on PATH."
fi

echo "[7/7] Running hardening script..."
sudo bash "$(dirname "$0")/hardening-ubuntu.sh"

echo "All steps completed."